import { useState, useEffect } from 'react'
import { ethers } from 'ethers'
import './App.css'

// Private Audit Contract Configuration
const CONTRACT_ADDRESS = "0x1408E6bea377D2a79118a320472473b0dFC1308F"
const CONTRACT_ABI = [
  "function createAccount(bytes calldata encryptedBalance, string calldata accountType) external returns (uint256)",
  "function updateBalance(uint256 accountId, bytes calldata encryptedNewBalance, string calldata updateType) external",
  "function initiateAudit(uint256 accountId, string calldata auditType) external returns (uint256)",
  "function completeAudit(uint256 auditId, bytes calldata encryptedFlag) external",
  "function getAccountInfo(uint256 accountId) external view returns (bool isActive, uint256 lastUpdated, address accountOwner, bytes32 accountType)",
  "function getUserAccounts(address user) external view returns (uint256[])",
  "function getEncryptedBalance(uint256 accountId) external view returns (bytes32)",
  "function getEncryptedTransactions(uint256 accountId) external view returns (bytes32)",
  "function getAuditRecord(uint256 auditId) external view returns (uint256 accountId, uint256 auditTimestamp, bool isCompleted, bytes32 auditType)",
  "function getAuditFlag(uint256 auditId) external view returns (bytes32)",
  "function getAccountAudits(uint256 accountId) external view returns (uint256[])",
  "function transferAuditor(address newAuditor) external",
  "function deactivateAccount(uint256 accountId) external",
  "function reactivateAccount(uint256 accountId) external",
  "function getTotalAccounts() external view returns (uint256)",
  "function auditor() external view returns (address)",
  "event AccountCreated(uint256 indexed accountId, address indexed owner, bytes32 accountType)",
  "event BalanceUpdated(uint256 indexed accountId, uint256 timestamp, bytes32 updateType)",
  "event AuditInitiated(uint256 indexed accountId, uint256 indexed auditId, bytes32 auditType)",
  "event AuditCompleted(uint256 indexed accountId, uint256 indexed auditId)",
  "event AuditorTransferred(address indexed previousAuditor, address indexed newAuditor)"
]

interface AccountInfo {
  id: number
  isActive: boolean
  lastUpdated: number
  owner: string
  accountType: string
}

interface TransactionStatus {
  hash: string
  status: 'pending' | 'confirmed' | 'failed'
  type: string
  timestamp: number
}

interface NetworkInfo {
  chainId: string
  name: string
  isConnected: boolean
  blockNumber?: number
}

function App() {
  const [account, setAccount] = useState<string>('')
  const [contract, setContract] = useState<ethers.Contract | null>(null)
  const [provider, setProvider] = useState<ethers.BrowserProvider | null>(null)
  const [signer, setSigner] = useState<ethers.Signer | null>(null)
  const [isAuditor, setIsAuditor] = useState<boolean>(false)
  const [userAccounts, setUserAccounts] = useState<AccountInfo[]>([])
  const [selectedAccount, setSelectedAccount] = useState<number | null>(null)
  const [loading, setLoading] = useState<boolean>(false)
  const [message, setMessage] = useState<string>('è¿æ¥é’±åŒ…å¼€å§‹ä½¿ç”¨æœºå¯†è´¢åŠ¡å®¡è®¡ç³»ç»Ÿ')
  const [activeTab, setActiveTab] = useState<'accounts' | 'audit' | 'transactions'>('accounts')
  const [transactionHistory, setTransactionHistory] = useState<TransactionStatus[]>([])
  const [networkInfo, setNetworkInfo] = useState<NetworkInfo>({ chainId: '', name: '', isConnected: false })
  const [balance, setBalance] = useState<string>('0')
  const [gasPrice, setGasPrice] = useState<string>('0')

  // Form states
  const [accountType, setAccountType] = useState<string>('')
  const [initialBalance, setInitialBalance] = useState<string>('')
  const [updateType, setUpdateType] = useState<string>('deposit')
  const [updateAmount, setUpdateAmount] = useState<string>('')
  const [auditType, setAuditType] = useState<string>('')
  const [auditFilter, setAuditFilter] = useState<string>('all')

  const showMessage = (msg: string) => {
    setMessage(msg)
  }

  const setLoadingState = (isLoading: boolean) => {
    setLoading(isLoading)
  }

  const connectWallet = async () => {
    try {
      if (!window.ethereum) {
        alert('è¯·å®‰è£… MetaMask é’±åŒ…!')
        return
      }

      setLoadingState(true)
      showMessage('æ­£åœ¨è¿æ¥ MetaMask...')

      // Request account access
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      })

      // Check and switch to Sepolia network
      const chainId = await window.ethereum.request({ method: 'eth_chainId' })
      const sepoliaChainId = '0xaa36a7' // 11155111 in hex
      
      if (chainId !== sepoliaChainId) {
        try {
          showMessage('æ­£åœ¨åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘ç»œ...')
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: sepoliaChainId }],
          })
        } catch (switchError: any) {
          // Network not added yet, add it
          if (switchError.code === 4902) {
            showMessage('æ­£åœ¨æ·»åŠ  Sepolia ç½‘ç»œ...')
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: sepoliaChainId,
                chainName: 'Sepolia Test Network',
                rpcUrls: ['https://sepolia.infura.io/v3/', 'https://rpc.sepolia.org'],
                nativeCurrency: {
                  name: 'Sepolia ETH',
                  symbol: 'SepoliaETH',
                  decimals: 18
                },
                blockExplorerUrls: ['https://sepolia.etherscan.io/']
              }]
            })
          } else {
            throw switchError
          }
        }
      }

      // Initialize ethers provider and signer
      const newProvider = new ethers.BrowserProvider(window.ethereum)
      const newSigner = await newProvider.getSigner()
      const contractInstance = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, newSigner)

      // Get network info and user balance
      const network = await newProvider.getNetwork()
      const userBalance = await newProvider.getBalance(accounts[0])
      const currentGasPrice = await newProvider.getFeeData()
      const blockNumber = await newProvider.getBlockNumber()

      // Update state
      setProvider(newProvider)
      setSigner(newSigner)
      setContract(contractInstance)
      setAccount(accounts[0])
      setBalance(ethers.formatEther(userBalance))
      setGasPrice(ethers.formatUnits(currentGasPrice.gasPrice || 0, 'gwei'))
      setNetworkInfo({
        chainId: '0x' + network.chainId.toString(16),
        name: network.name,
        isConnected: true,
        blockNumber
      })

      showMessage('å·²æˆåŠŸè¿æ¥åˆ° Sepolia æµ‹è¯•ç½‘ç»œ âœ…')

      // Load user data from blockchain
      await loadUserData(contractInstance, accounts[0])

      // Setup event listeners for account/network changes
      setupEventListeners()

    } catch (error: any) {
      console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error)
      showMessage('é’±åŒ…è¿æ¥å¤±è´¥: ' + (error.message || error))
    } finally {
      setLoadingState(false)
    }
  }

  const setupEventListeners = () => {
    if (!window.ethereum) return

    // Listen for account changes
    window.ethereum.on('accountsChanged', (accounts: string[]) => {
      if (accounts.length === 0) {
        // User disconnected
        disconnectWallet()
      } else {
        // Account changed
        setAccount(accounts[0])
        if (contract) {
          loadUserData(contract, accounts[0])
        }
      }
    })

    // Listen for network changes
    window.ethereum.on('chainChanged', (chainId: string) => {
      // Reload the page to reset state
      window.location.reload()
    })
  }

  const disconnectWallet = () => {
    setAccount('')
    setContract(null)
    setProvider(null)
    setSigner(null)
    setUserAccounts([])
    setSelectedAccount(null)
    setBalance('0')
    setNetworkInfo({ chainId: '', name: '', isConnected: false })
    showMessage('é’±åŒ…å·²æ–­å¼€è¿æ¥')
  }

  const loadUserData = async (contractInstance: ethers.Contract, userAddress: string) => {
    try {
      showMessage('æ­£åœ¨ä»åŒºå—é“¾åŠ è½½è´¦æˆ·æ•°æ®...')

      // Get user accounts from contract
      const accountIds = await contractInstance.getUserAccounts(userAddress)
      const loadedAccounts: AccountInfo[] = []

      for (const id of accountIds) {
        try {
          const info = await contractInstance.getAccountInfo(id)
          loadedAccounts.push({
            id: Number(id),
            isActive: info[0],
            lastUpdated: Number(info[1]),
            owner: info[2],
            accountType: ethers.toUtf8String(info[3]).slice(0, 20) // Truncate for display
          })
        } catch (error) {
          console.error(`Failed to load account ${id}:`, error)
        }
      }

      setUserAccounts(loadedAccounts)

      // Check if user is auditor
      try {
        const auditorAddress = await contractInstance.auditor()
        setIsAuditor(auditorAddress.toLowerCase() === userAddress.toLowerCase())
      } catch (error) {
        console.error('Failed to check auditor status:', error)
        setIsAuditor(false)
      }

      showMessage('è´¦æˆ·æ•°æ®åŠ è½½å®Œæˆ âœ…')

    } catch (error: any) {
      console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
      showMessage('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ' + error.message)
    }
  }

  const createAccount = async () => {
    if (!contract || !signer || !accountType || !initialBalance) {
      showMessage('è¯·é€‰æ‹©è´¦æˆ·ç±»å‹å¹¶è¾“å…¥åˆå§‹ä½™é¢')
      return
    }

    try {
      setLoadingState(true)
      showMessage('æ­£åœ¨ä¼°ç®— Gas è´¹ç”¨...')

      // Convert balance to encrypted bytes (FHEVM format)
      const balanceWei = ethers.parseEther(initialBalance)
      const encryptedBalance = ethers.toUtf8Bytes(balanceWei.toString()) // Simplified encryption for demo

      // Estimate gas
      const gasEstimate = await contract.createAccount.estimateGas(
        encryptedBalance,
        accountType
      )
      
      const gasLimit = gasEstimate + (gasEstimate * 20n / 100n) // Add 20% buffer
      const feeData = await provider!.getFeeData()
      const gasPrice = feeData.gasPrice!
      const estimatedCost = gasLimit * gasPrice

      showMessage(`ä¼°ç®— Gas: ${gasLimit.toString()}, è´¹ç”¨: ${ethers.formatEther(estimatedCost)} ETH`)
      
      // Create transaction with proper gas settings
      showMessage('æ­£åœ¨åˆ›å»ºäº¤æ˜“ï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤...')
      
      const txResponse = await contract.createAccount(
        encryptedBalance,
        accountType,
        {
          gasLimit: gasLimit,
          gasPrice: gasPrice
        }
      )

      // Add to transaction history
      const newTx: TransactionStatus = {
        hash: txResponse.hash,
        status: 'pending',
        type: `åˆ›å»ºè´¦æˆ· (${accountType})`,
        timestamp: Date.now()
      }
      setTransactionHistory(prev => [newTx, ...prev])

      showMessage(`äº¤æ˜“å·²æäº¤! å“ˆå¸Œ: ${txResponse.hash}`)
      showMessage('ç­‰å¾…åŒºå—ç¡®è®¤...')

      // Wait for confirmation
      const receipt = await txResponse.wait()
      
      if (receipt.status === 1) {
        // Update transaction status
        setTransactionHistory(prev => 
          prev.map(tx => 
            tx.hash === txResponse.hash 
              ? { ...tx, status: 'confirmed' as const }
              : tx
          )
        )
        
        showMessage(`è´¦æˆ·åˆ›å»ºæˆåŠŸ! åŒºå—: ${receipt.blockNumber}`)
        
        // Reset form
        setAccountType('')
        setInitialBalance('')

        // Reload user data
        await loadUserData(contract, account)
        
        // Update balance
        const newBalance = await provider!.getBalance(account)
        setBalance(ethers.formatEther(newBalance))
        
      } else {
        throw new Error('äº¤æ˜“å¤±è´¥')
      }

    } catch (error: any) {
      console.error('åˆ›å»ºè´¦æˆ·å¤±è´¥:', error)
      
      // Update transaction status if hash exists
      if (error.hash) {
        setTransactionHistory(prev => 
          prev.map(tx => 
            tx.hash === error.hash 
              ? { ...tx, status: 'failed' as const }
              : tx
          )
        )
      }
      
      let errorMessage = 'åˆ›å»ºè´¦æˆ·å¤±è´¥'
      if (error.code === 'ACTION_REJECTED') {
        errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“'
      } else if (error.code === 'INSUFFICIENT_FUNDS') {
        errorMessage = 'ETH ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨'
      } else if (error.message) {
        errorMessage += ': ' + error.message
      }
      
      showMessage(errorMessage)
    } finally {
      setLoadingState(false)
    }
  }

  const updateAccountBalance = async () => {
    if (!contract || !signer || selectedAccount === null || !updateType || !updateAmount) {
      showMessage('è¯·é€‰æ‹©æ›´æ–°ç±»å‹å¹¶è¾“å…¥é‡‘é¢')
      return
    }

    try {
      setLoadingState(true)
      showMessage('æ­£åœ¨ä¼°ç®— Gas è´¹ç”¨...')

      // Convert amount to encrypted bytes (FHEVM format)
      const amountWei = ethers.parseEther(updateAmount)
      const encryptedAmount = ethers.toUtf8Bytes(amountWei.toString()) // Simplified encryption

      // Estimate gas
      const gasEstimate = await contract.updateBalance.estimateGas(
        selectedAccount,
        encryptedAmount,
        updateType
      )
      
      const gasLimit = gasEstimate + (gasEstimate * 20n / 100n)
      const feeData = await provider!.getFeeData()
      const gasPrice = feeData.gasPrice!
      const estimatedCost = gasLimit * gasPrice

      showMessage(`ä¼°ç®— Gas: ${gasLimit.toString()}, è´¹ç”¨: ${ethers.formatEther(estimatedCost)} ETH`)
      
      // Create transaction
      showMessage('æ­£åœ¨æ›´æ–°ä½™é¢ï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤...')
      
      const txResponse = await contract.updateBalance(
        selectedAccount,
        encryptedAmount,
        updateType,
        {
          gasLimit: gasLimit,
          gasPrice: gasPrice
        }
      )

      // Add to transaction history
      const newTx: TransactionStatus = {
        hash: txResponse.hash,
        status: 'pending',
        type: `æ›´æ–°ä½™é¢ - ${updateType}`,
        timestamp: Date.now()
      }
      setTransactionHistory(prev => [newTx, ...prev])

      showMessage(`äº¤æ˜“å·²æäº¤! å“ˆå¸Œ: ${txResponse.hash}`)
      showMessage('ç­‰å¾…åŒºå—ç¡®è®¤...')

      // Wait for confirmation
      const receipt = await txResponse.wait()
      
      if (receipt.status === 1) {
        // Update transaction status
        setTransactionHistory(prev => 
          prev.map(tx => 
            tx.hash === txResponse.hash 
              ? { ...tx, status: 'confirmed' as const }
              : tx
          )
        )
        
        showMessage(`ä½™é¢æ›´æ–°æˆåŠŸ! åŒºå—: ${receipt.blockNumber}`)
        
        // Reset form
        setUpdateType('deposit')
        setUpdateAmount('')

        // Reload user data
        await loadUserData(contract, account)
        
        // Update balance
        const newBalance = await provider!.getBalance(account)
        setBalance(ethers.formatEther(newBalance))
        
      } else {
        throw new Error('äº¤æ˜“å¤±è´¥')
      }

    } catch (error: any) {
      console.error('æ›´æ–°ä½™é¢å¤±è´¥:', error)
      
      if (error.hash) {
        setTransactionHistory(prev => 
          prev.map(tx => 
            tx.hash === error.hash 
              ? { ...tx, status: 'failed' as const }
              : tx
          )
        )
      }
      
      let errorMessage = 'æ›´æ–°ä½™é¢å¤±è´¥'
      if (error.code === 'ACTION_REJECTED') {
        errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“'
      } else if (error.code === 'INSUFFICIENT_FUNDS') {
        errorMessage = 'ETH ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨'
      } else if (error.message) {
        errorMessage += ': ' + error.message
      }
      
      showMessage(errorMessage)
    } finally {
      setLoadingState(false)
    }
  }

  const initiateAudit = async (accountId: number) => {
    if (!contract || !signer || !isAuditor || !auditType) {
      showMessage('è¯·é€‰æ‹©å®¡è®¡ç±»å‹ï¼Œåªæœ‰å®¡è®¡å‘˜å¯ä»¥å‘èµ·å®¡è®¡')
      return
    }

    try {
      setLoadingState(true)
      showMessage('æ­£åœ¨ä¼°ç®— Gas è´¹ç”¨...')

      // Estimate gas
      const gasEstimate = await contract.initiateAudit.estimateGas(
        accountId,
        auditType
      )
      
      const gasLimit = gasEstimate + (gasEstimate * 20n / 100n)
      const feeData = await provider!.getFeeData()
      const gasPrice = feeData.gasPrice!
      const estimatedCost = gasLimit * gasPrice

      showMessage(`ä¼°ç®— Gas: ${gasLimit.toString()}, è´¹ç”¨: ${ethers.formatEther(estimatedCost)} ETH`)
      
      // Create transaction
      showMessage('æ­£åœ¨å‘èµ·å®¡è®¡ï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤...')
      
      const txResponse = await contract.initiateAudit(
        accountId,
        auditType,
        {
          gasLimit: gasLimit,
          gasPrice: gasPrice
        }
      )

      // Add to transaction history
      const newTx: TransactionStatus = {
        hash: txResponse.hash,
        status: 'pending',
        type: `å‘èµ·å®¡è®¡ - ${auditType}`,
        timestamp: Date.now()
      }
      setTransactionHistory(prev => [newTx, ...prev])

      showMessage(`å®¡è®¡äº¤æ˜“å·²æäº¤! å“ˆå¸Œ: ${txResponse.hash}`)
      showMessage('ç­‰å¾…åŒºå—ç¡®è®¤...')

      // Wait for confirmation
      const receipt = await txResponse.wait()
      
      if (receipt.status === 1) {
        // Update transaction status
        setTransactionHistory(prev => 
          prev.map(tx => 
            tx.hash === txResponse.hash 
              ? { ...tx, status: 'confirmed' as const }
              : tx
          )
        )
        
        showMessage(`å®¡è®¡å‘èµ·æˆåŠŸ! åŒºå—: ${receipt.blockNumber}`)
        
        // Reset form
        setAuditType('')
        
        // Update balance
        const newBalance = await provider!.getBalance(account)
        setBalance(ethers.formatEther(newBalance))
        
      } else {
        throw new Error('äº¤æ˜“å¤±è´¥')
      }

    } catch (error: any) {
      console.error('å‘èµ·å®¡è®¡å¤±è´¥:', error)
      
      if (error.hash) {
        setTransactionHistory(prev => 
          prev.map(tx => 
            tx.hash === error.hash 
              ? { ...tx, status: 'failed' as const }
              : tx
          )
        )
      }
      
      let errorMessage = 'å‘èµ·å®¡è®¡å¤±è´¥'
      if (error.code === 'ACTION_REJECTED') {
        errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“'
      } else if (error.code === 'INSUFFICIENT_FUNDS') {
        errorMessage = 'ETH ä½™é¢ä¸è¶³æ”¯ä»˜ Gas è´¹ç”¨'
      } else if (error.message) {
        errorMessage += ': ' + error.message
      }
      
      showMessage(errorMessage)
    } finally {
      setLoadingState(false)
    }
  }

  return (
    <div className="terminal-box">
      <h1 className="title">æœºå¯†è´¢åŠ¡å®¡è®¡ç³»ç»Ÿ</h1>
      <p className="subtitle">Privacy-Preserving Financial Audit</p>

      {/* Network Info */}
      <div className="blockchain-info">
        <p>&gt; <strong>Sepolia æµ‹è¯•ç½‘ç»œ</strong> - åŸºäº FHEVM çš„éšç§ä¿æŠ¤</p>
        <p>&gt; åˆçº¦åœ°å€: <span className="highlight">0xa57c...3298</span></p>
        {networkInfo.isConnected && (
          <>
            <p>&gt; ç½‘ç»œ: <span className="highlight">{networkInfo.name}</span></p>
            <p>&gt; é“¾ ID: <span className="highlight">{networkInfo.chainId}</span></p>
            {networkInfo.blockNumber && (
              <p>&gt; æœ€æ–°åŒºå—: <span className="highlight">{networkInfo.blockNumber}</span></p>
            )}
          </>
        )}
        {account && (
          <>
            <p>&gt; é’±åŒ…ä½™é¢: <span className="highlight">{parseFloat(balance).toFixed(4)} ETH</span></p>
            <p>&gt; Gas ä»·æ ¼: <span className="highlight">{parseFloat(gasPrice).toFixed(2)} Gwei</span></p>
          </>
        )}
      </div>

      {/* Description */}
      <div className="terminal-text">
        <p>&gt; æ¬¢è¿ä½¿ç”¨æœºå¯†è´¢åŠ¡å®¡è®¡ç³»ç»Ÿ</p>
        <p>&gt; æ‰€æœ‰è´¢åŠ¡æ•°æ®å‡é‡‡ç”¨å…¨åŒæ€åŠ å¯†(FHE)æŠ€æœ¯ä¿æŠ¤</p>
        <p>&gt; è´¦æˆ·ä½™é¢å’Œäº¤æ˜“è®°å½•å®Œå…¨åŠ å¯†å­˜å‚¨</p>
        <p>&gt; å®¡è®¡å‘˜å¯ä»¥åœ¨ä¸æ³„éœ²å…·ä½“æ•°å€¼çš„æƒ…å†µä¸‹è¿›è¡Œå®¡è®¡</p>
        <p>&gt; åŸºäº Zama FHEVM æŠ€æœ¯ï¼Œç¡®ä¿éšç§å®‰å…¨</p>
      </div>

      {/* Status Message */}
      <div className="message-box">
        <p>&gt; {message}</p>
      </div>

      {/* Tab Navigation */}
      {account && (
        <div className="tab-navigation">
          <button 
            className={`tab-button ${activeTab === 'accounts' ? 'active' : ''}`}
            onClick={() => setActiveTab('accounts')}
          >
            è´¦æˆ·ç®¡ç†
          </button>
          <button 
            className={`tab-button ${activeTab === 'audit' ? 'active' : ''}`}
            onClick={() => setActiveTab('audit')}
          >
            å®¡è®¡åŠŸèƒ½
          </button>
          <button 
            className={`tab-button ${activeTab === 'transactions' ? 'active' : ''}`}
            onClick={() => setActiveTab('transactions' as any)}
          >
            äº¤æ˜“å†å²
          </button>
        </div>
      )}

      {/* Account Management Tab */}
      {account && activeTab === 'accounts' && (
        <div className="account-section">
          <h3>åˆ›å»ºæ–°è´¦æˆ·</h3>
          <div className="input-group">
            <select 
              className="input-box" 
              value={accountType}
              onChange={(e) => setAccountType(e.target.value)}
            >
              <option value="">é€‰æ‹©è´¦æˆ·ç±»å‹</option>
              <option value="company">ä¼ä¸šè´¦æˆ·</option>
              <option value="personal">ä¸ªäººè´¦æˆ·</option>
              <option value="institutional">æœºæ„è´¦æˆ·</option>
              <option value="government">æ”¿åºœè´¦æˆ·</option>
            </select>
            <input
              className="input-box"
              type="number"
              placeholder="è¾“å…¥åˆå§‹ä½™é¢ (ETH)"
              step="0.001"
              min="0"
              value={initialBalance}
              onChange={(e) => setInitialBalance(e.target.value)}
            />
            <button 
              className="button create-button" 
              onClick={createAccount}
              disabled={loading}
            >
              {loading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºè´¦æˆ·'}
            </button>
          </div>

          {/* Preset Balance Options */}
          <div className="preset-section">
            <h4>å¸¸ç”¨ä½™é¢é¢„è®¾</h4>
            <div className="preset-buttons">
              <button className="preset-btn" onClick={() => setInitialBalance('0.1')}>0.1 ETH</button>
              <button className="preset-btn" onClick={() => setInitialBalance('0.5')}>0.5 ETH</button>
              <button className="preset-btn" onClick={() => setInitialBalance('1.0')}>1.0 ETH</button>
              <button className="preset-btn" onClick={() => setInitialBalance('5.0')}>5.0 ETH</button>
            </div>
          </div>

          <h3>æˆ‘çš„è´¦æˆ·</h3>
          {userAccounts.length > 0 ? (
            <div className="account-list">
              {userAccounts.map((acc) => (
                <div key={acc.id} className="account-item">
                  <p>è´¦æˆ· #{acc.id}</p>
                  <p>ç±»å‹: {acc.accountType || 'æœªçŸ¥'}</p>
                  <p>çŠ¶æ€: {acc.isActive ? 'æ´»è·ƒ' : 'åœç”¨'}</p>
                  <p>æœ€åæ›´æ–°: {new Date(acc.lastUpdated * 1000).toLocaleString()}</p>
                  <button 
                    className="button select-button"
                    onClick={() => setSelectedAccount(acc.id)}
                    disabled={!acc.isActive}
                  >
                    {selectedAccount === acc.id ? 'å·²é€‰æ‹©' : 'é€‰æ‹©'}
                  </button>
                </div>
              ))}
            </div>
          ) : (
            <p>æš‚æ— è´¦æˆ·ï¼Œè¯·åˆ›å»ºç¬¬ä¸€ä¸ªè´¦æˆ·</p>
          )}

          {selectedAccount !== null && (
            <div className="balance-update">
              <h3>æ›´æ–°ä½™é¢ - è´¦æˆ· #{selectedAccount}</h3>
              <div className="input-group">
                <select 
                  className="input-box" 
                  value={updateType}
                  onChange={(e) => setUpdateType(e.target.value)}
                >
                  <option value="deposit">å­˜æ¬¾</option>
                  <option value="withdraw">ææ¬¾</option>
                  <option value="transfer">è½¬è´¦</option>
                  <option value="payment">æ”¯ä»˜</option>
                </select>
                <input
                  className="input-box"
                  type="number"
                  placeholder="è¾“å…¥é‡‘é¢ (ETH)"
                  step="0.001"
                  min="0"
                  value={updateAmount}
                  onChange={(e) => setUpdateAmount(e.target.value)}
                />
                <button 
                  className="button update-button" 
                  onClick={updateAccountBalance}
                  disabled={loading}
                >
                  {loading ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°ä½™é¢'}
                </button>
              </div>
              
              {/* Preset Update Amounts */}
              <div className="preset-section">
                <h4>å¸¸ç”¨é‡‘é¢é¢„è®¾</h4>
                <div className="preset-buttons">
                  <button className="preset-btn" onClick={() => setUpdateAmount('0.01')}>0.01 ETH</button>
                  <button className="preset-btn" onClick={() => setUpdateAmount('0.1')}>0.1 ETH</button>
                  <button className="preset-btn" onClick={() => setUpdateAmount('1.0')}>1.0 ETH</button>
                  <button className="preset-btn" onClick={() => setUpdateAmount('10.0')}>10.0 ETH</button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

        {/* Audit Tab */}
        {account && activeTab === 'audit' && (
          <div className="content-section">
            {isAuditor ? (
              <>
                <h2 className="section-title">å®¡è®¡å‘˜åŠŸèƒ½</h2>
                <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                  ä½œä¸ºå®¡è®¡å‘˜ï¼Œæ‚¨å¯ä»¥å¯¹è´¦æˆ·è¿›è¡Œéšç§ä¿æŠ¤å®¡è®¡
                </p>
                
                {/* Audit Type Selection */}
                <div className="form-group">
                  <div className="form-field">
                    <label className="field-label">å®¡è®¡ç±»å‹</label>
                    <select 
                      className="select-field" 
                      value={auditType}
                      onChange={(e) => setAuditType(e.target.value)}
                    >
                      <option value="">é€‰æ‹©å®¡è®¡ç±»å‹</option>
                      <option value="compliance">åˆè§„æ€§å®¡è®¡</option>
                      <option value="financial">è´¢åŠ¡å®¡è®¡</option>
                      <option value="operational">è¿è¥å®¡è®¡</option>
                      <option value="security">å®‰å…¨å®¡è®¡</option>
                    </select>
                  </div>
                </div>
                
                <div className="card-grid">
                  {userAccounts.map((acc) => (
                    <div key={acc.id} className="card">
                      <div className="card-header">
                        <div className="card-title">è´¦æˆ· #{acc.id}</div>
                        <div className={`status-badge ${acc.isActive ? 'status-active' : 'status-inactive'}`}>
                          {acc.isActive ? 'å¯å®¡è®¡' : 'å·²åœç”¨'}
                        </div>
                      </div>
                      <div className="card-content">
                        <div className="card-meta">ç±»å‹: {acc.accountType || 'æœªçŸ¥'}</div>
                        <div className="card-meta">æœ€åæ›´æ–°: {new Date(acc.lastUpdated * 1000).toLocaleString()}</div>
                      </div>
                      <div className="card-actions">
                        <button 
                          className="btn btn-warning"
                          onClick={() => initiateAudit(acc.id)}
                          disabled={loading || !acc.isActive || !auditType}
                        >
                          å‘èµ·å®¡è®¡
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            ) : (
              <>
                <h2 className="section-title">å®¡è®¡è®°å½•</h2>
                <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                  æ‚¨ä¸æ˜¯å®¡è®¡å‘˜ï¼Œæ— æ³•æ‰§è¡Œå®¡è®¡æ“ä½œã€‚æ‚¨å¯ä»¥æŸ¥çœ‹è‡ªå·±è´¦æˆ·çš„å®¡è®¡å†å²è®°å½•ã€‚
                </p>
                
                {/* Audit History Filters */}
                <div className="form-group">
                  <div className="form-field">
                    <label className="field-label">ç­›é€‰æ¡ä»¶</label>
                    <select 
                      className="select-field" 
                      value={auditFilter}
                      onChange={(e) => setAuditFilter(e.target.value)}
                    >
                      <option value="all">æ‰€æœ‰å®¡è®¡</option>
                      <option value="pending">å¾…å¤„ç†</option>
                      <option value="completed">å·²å®Œæˆ</option>
                      <option value="failed">å®¡è®¡å¼‚å¸¸</option>
                    </select>
                  </div>
                  <button className="btn btn-secondary">
                    æŸ¥çœ‹è®°å½•
                  </button>
                </div>
                
                <div className="empty-state">
                  <div className="empty-icon">ğŸ“‹</div>
                  <div className="empty-title">æš‚æ— å®¡è®¡è®°å½•</div>
                  <div className="empty-description">å½“å®¡è®¡å‘˜å¯¹æ‚¨çš„è´¦æˆ·è¿›è¡Œå®¡è®¡æ—¶ï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
              </>
            )}
          </div>
        )}

        {/* Transaction History Tab */}
        {account && activeTab === 'transactions' && (
          <div className="content-section">
            <h2 className="section-title">äº¤æ˜“å†å²</h2>
            {transactionHistory.length > 0 ? (
              <div className="transaction-list">
                {transactionHistory.map((tx, index) => (
                  <div key={index} className={`transaction-item ${tx.status}`}>
                    <div className="transaction-header">
                      <div className="transaction-type">{tx.type}</div>
                      <div className={`status-badge status-${tx.status}`}>
                        {tx.status === 'pending' && 'ç­‰å¾…ä¸­'}
                        {tx.status === 'confirmed' && 'å·²ç¡®è®¤'}
                        {tx.status === 'failed' && 'å¤±è´¥'}
                      </div>
                    </div>
                    <div className="transaction-details">
                      <div className="transaction-detail">
                        <div className="detail-label">äº¤æ˜“å“ˆå¸Œ</div>
                        <div className="detail-value">
                          <a 
                            href={`https://sepolia.etherscan.io/tx/${tx.hash}`} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="detail-link"
                          >
                            {tx.hash.slice(0, 10)}...{tx.hash.slice(-8)}
                          </a>
                        </div>
                      </div>
                      <div className="transaction-detail">
                        <div className="detail-label">æ—¶é—´</div>
                        <div className="detail-value">{new Date(tx.timestamp).toLocaleString()}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="empty-state">
                <div className="empty-icon">ğŸ“œ</div>
                <div className="empty-title">æš‚æ— äº¤æ˜“è®°å½•</div>
                <div className="empty-description">å¼€å§‹ä½¿ç”¨ç³»ç»Ÿåï¼Œäº¤æ˜“å†å²å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
              </div>
            )}
            
            {/* Gas Price Monitor */}
            <div className="gas-monitor">
              <div className="gas-title">â›½ Gas ç›‘æ§</div>
              <div className="gas-info">
                <div className="gas-item">
                  <div className="gas-label">å½“å‰ Gas ä»·æ ¼</div>
                  <div className="gas-value">{parseFloat(gasPrice).toFixed(2)} Gwei</div>
                </div>
                <div className="gas-item">
                  <div className="gas-label">é’±åŒ…ä½™é¢</div>
                  <div className="gas-value">{parseFloat(balance).toFixed(6)} ETH</div>
                </div>
                <button 
                  className="btn btn-secondary"
                  onClick={async () => {
                    if (provider) {
                      const feeData = await provider.getFeeData()
                      const newBalance = await provider.getBalance(account)
                      setGasPrice(ethers.formatUnits(feeData.gasPrice || 0, 'gwei'))
                      setBalance(ethers.formatEther(newBalance))
                      showMessage('Gas ä»·æ ¼å·²æ›´æ–°')
                    }
                  }}
                  disabled={loading}
                >
                  åˆ·æ–°
                </button>
              </div>
            </div>
          </div>
        )}

      {/* Connect Button */}
      <div className="button-group">
        {!account ? (
          <button 
            className="wallet-button" 
            onClick={connectWallet}
            disabled={loading}
          >
            {loading ? 'è¿æ¥ä¸­...' : 'è¿æ¥é’±åŒ…'}
          </button>
        ) : (
          <div className="wallet-info">
            <button className="wallet-button connected" disabled>
              {account.slice(0, 6)}...{account.slice(-4)}
            </button>
            <button 
              className="button disconnect-button"
              onClick={disconnectWallet}
              disabled={loading}
            >
              æ–­å¼€è¿æ¥
            </button>
          </div>
        )}
      </div>

      {/* Footer */}
      <div className="footer">
        <p>&gt; åŸºäº Zama FHEVM çš„éšç§ä¿æŠ¤å®¡è®¡ç³»ç»Ÿ</p>
        <p>&gt; æ‰€æœ‰æ•°æ®å‡ç»è¿‡å…¨åŒæ€åŠ å¯†ä¿æŠ¤</p>
      </div>
    </div>
  )
}

export default App